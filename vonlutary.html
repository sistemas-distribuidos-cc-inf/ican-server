<!DOCTYPE html>
<html>

<head>
  <title>ican-web</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>

<body>
  <div id="textRoom" style="display: none;">
    <div id="textRoomContent">
      <h3>Text Room</h3>
    </div>
    <input id="textRoomInput">
    <button onclick="textRoomPress();">Send</button>
  </div>
  <video id="selfView" autoplay></video>
  <div id="remoteViewContainer"></div>
  <div id="roomIDContainer">
    <input id="roomID" value="teste">
    <button onclick="press();">Join/Create room</button>
  </div>
</body>
<script src="/socket.io/socket.io.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCI1tgkmUoDt6UsmnCBE5NHJIm28MSn8-8",
    authDomain: "ican-app.firebaseapp.com",
    databaseURL: "https://ican-app.firebaseio.com",
    projectId: "ican-app",
    storageBucket: "ican-app.appspot.com",
    messagingSenderId: "129462824669"
  };
  firebase.initializeApp(config);
</script>
<script type="text/javascript">
  debugger
  var socket = io();

  var RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection || window.msRTCPeerConnection;
  var RTCSessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription || window.webkitRTCSessionDescription || window.msRTCSessionDescription;
  navigator.getUserMedia = navigator.getUserMedia || navigator.mozGetUserMedia || navigator.webkitGetUserMedia || navigator.msGetUserMedia;

  var twilioIceServers = [
    { url: 'stun:global.stun.twilio.com:3478?transport=udp' }
    // { url: 'turn:global.turn.twilio.com:3478?transport=udp',
    //   username: 'ea757ad2c42b932c7f2abe480295e7eb039dc2b13b78c86bc412818ed51e5eea',
    //   credential: 'MPnnojPRoPDI+B3kLONGF9P440Lb8NkrTq+FxxJBVro=' },
    // { url: 'turn:global.turn.twilio.com:3478?transport=tcp',
    //   username: 'ea757ad2c42b932c7f2abe480295e7eb039dc2b13b78c86bc412818ed51e5eea',
    //   credential: 'MPnnojPRoPDI+B3kLONGF9P440Lb8NkrTq+FxxJBVro=' },
    // { url: 'turn:global.turn.twilio.com:443?transport=tcp',
    //   username: 'ea757ad2c42b932c7f2abe480295e7eb039dc2b13b78c86bc412818ed51e5eea',
    //   credential: 'MPnnojPRoPDI+B3kLONGF9P440Lb8NkrTq+FxxJBVro=' } 
  ];
  var configuration = { "iceServers": [{ "url": "stun:stun.l.google.com:19302" }] };
  // configuration.iceServers = twilioIceServers;

  var pcPeers = {};
  var selfView = document.getElementById("selfView");
  var remoteViewContainer = document.getElementById("remoteViewContainer");
  var localStream;

  function getLocalStream() {
    navigator.getUserMedia({ "audio": true, "video": true }, function (stream) {
      localStream = stream;
      selfView.src = URL.createObjectURL(stream);
      selfView.muted = true;
    }, logError);
  }

  function join(roomID) {
    // debugger
    // firebase.auth().signInAnonymously().then(() => {
    //   const obj = {
    //     video: true,
    //     voice: true,
    //     chat: true
    //   };
    socket.emit('join', 'vonlutary', function (socketId) {
      debugger
      if (socketId)
        createPC(socketId, true);
      // if(obj.anonymous && obj.anonymous.socketId)
      //     createPC(obj.anonymous.socketId, true);
      // console.log('join', socketIds);
      // for (var i in socketIds) {
      //     var socketId = socketIds[i];
      // }
    });
    // });
  }

  function createPC(socketId, isOffer) {
    debugger
    var pc = new RTCPeerConnection(configuration);
    pcPeers[socketId] = pc;

    pc.onicecandidate = function (event) {
      debugger
      console.log('onicecandidate', event);
      if (event.candidate) {
        socket.emit('exchange', { 'to': socketId, 'candidate': event.candidate });
      }
    };

    function createOffer() {
      pc.createOffer(function (desc) {
        debugger
        console.log('createOffer', desc);
        pc.setLocalDescription(desc, function () {
          console.log('setLocalDescription', pc.localDescription);
          socket.emit('exchange', { 'to': socketId, 'sdp': pc.localDescription });
        }, logError);
      }, logError);
    }

    pc.onnegotiationneeded = function () {
      console.log('onnegotiationneeded');
      if (isOffer) {
        createOffer();
      }
    }

<<<<<<< HEAD
    dataChannel.onerror = function (error) {
      debugger
      console.log("dataChannel.onerror", error);
    };

    dataChannel.onmessage = function (event) {
      debugger
      console.log("dataChannel.onmessage:", event.data);
      var content = document.getElementById('textRoomContent');
      content.innerHTML = content.innerHTML + '<p>' + socketId + ': ' + event.data + '</p>';
=======
    pc.oniceconnectionstatechange = function (event) {
      console.log('oniceconnectionstatechange', event);
      if (event.target.iceConnectionState === 'connected') {
        createDataChannel();
      }
    };
    pc.onsignalingstatechange = function (event) {
      console.log('onsignalingstatechange', event);
>>>>>>> 9dc9c5bfcce03bfb81754a3b23a14012fd416f41
    };

    pc.onaddstream = function (event) {
      debugger
      console.log('onaddstream', event);
      var element = document.createElement('video');
      element.id = "remoteView" + socketId;
      element.autoplay = 'autoplay';
      element.src = URL.createObjectURL(event.stream);
      debugger
      remoteViewContainer.appendChild(element);
    };
    pc.addStream(localStream);
    function createDataChannel() {
      if (pc.textDataChannel) {
        return;
      }
      var dataChannel = pc.createDataChannel("text");

      dataChannel.onerror = function (error) {
        console.log("dataChannel.onerror", error);
      };

      dataChannel.onmessage = function (event) {
        console.log("dataChannel.onmessage:", event.data);
        var content = document.getElementById('textRoomContent');
        content.innerHTML = content.innerHTML + '<p>' + socketId + ': ' + event.data + '</p>';
      };

      dataChannel.onopen = function () {
        console.log('dataChannel.onopen');
        var textRoom = document.getElementById('textRoom');
        textRoom.style.display = "block";
      };

      dataChannel.onclose = function () {
        console.log("dataChannel.onclose");
      };

      pc.textDataChannel = dataChannel;
    }
    return pc;
  }

  function exchange(data) {
    debugger
    var fromId = data.from;
    var pc;
    if (fromId in pcPeers) {
      pc = pcPeers[fromId];
    } else {
      pc = createPC(fromId, false);
    }

    if (data.sdp) {
      console.log('exchange sdp', data);
      pc.setRemoteDescription(new RTCSessionDescription(data.sdp), function () {
        if (pc.remoteDescription.type == "offer")
          pc.createAnswer(function (desc) {
            console.log('createAnswer', desc);
            pc.setLocalDescription(desc, function () {
              console.log('setLocalDescription', pc.localDescription);
              socket.emit('exchange', { 'to': fromId, 'sdp': pc.localDescription });
            }, logError);
          }, logError);
      }, logError);
    } else {
      console.log('exchange candidate', data);
      pc.addIceCandidate(new RTCIceCandidate(data.candidate));
    }
  }

  function leave(socketId) {
    console.log('leave', socketId);
    var pc = pcPeers[socketId];
    pc.close();
    delete pcPeers[socketId];
    var video = document.getElementById("remoteView" + socketId);
    if (video) video.remove();
  }

  socket.on('exchange', function (data) {
    debugger
    exchange(data);
  });
  socket.on('leave', function (socketId) {
    leave(socketId);
  });

  socket.on('connect', function (data) {
    console.log('connect');
    getLocalStream();
  });

  function logError(error) {
    console.log("logError", error);
  }

  function press() {
    debugger
    var roomID = document.getElementById('roomID').value;
    if (roomID == "") {
      alert('Please enter room ID');
    } else {
      var roomIDContainer = document.getElementById('roomIDContainer');
      roomIDContainer.parentElement.removeChild(roomIDContainer);
      debugger
      join(roomID);
    }
  }
<<<<<<< HEAD
}
function textRoomPress() {
  var text = document.getElementById('textRoomInput').value;
  if (text == "") {
    alert('Enter something');
  } else {
    debugger
    document.getElementById('textRoomInput').value = '';
    var content = document.getElementById('textRoomContent');
    content.innerHTML = content.innerHTML + '<p>' + 'Me' + ': ' + text + '</p>';
    for (var key in pcPeers) {
      var pc = pcPeers[key];
      pc.textDataChannel.send(text);
=======
  function textRoomPress() {
    var text = document.getElementById('textRoomInput').value;
    if (text == "") {
      alert('Enter something');
    } else {
      document.getElementById('textRoomInput').value = '';
      var content = document.getElementById('textRoomContent');
      content.innerHTML = content.innerHTML + '<p>' + 'Me' + ': ' + text + '</p>';
      for (var key in pcPeers) {
        var pc = pcPeers[key];
        pc.textDataChannel.send(text);
      }
>>>>>>> 9dc9c5bfcce03bfb81754a3b23a14012fd416f41
    }
  }

</script>

</html>